# Updates repository Refs on all pipelines
parameters:
  Tag: ''
  ToolRepo: ''
  Repos:
    - azure-sdk-for-android
    - azure-sdk-for-c
    - azure-sdk-for-cpp
    - azure-sdk-for-go
    - azure-sdk-for-ios
    - azure-sdk-for-java
    - azure-sdk-for-js
    - azure-sdk-for-net
    - azure-sdk-for-python

steps:

- ${{ each repo in parameters.Repos }}:
  - pwsh: |
      git clone --branch master https://github.com/azure/${{ repo }}
    displayName: Clone ${{ repo }}
    workingDirectory: $(System.DefaultWorkingDirectory)

  - task: Powershell@2
    inputs:
      targetType: 'filePath'
      filePath: ${{ parameters.ToolRepo }}/scripts/powershell/ref-updater.ps1
      arguments: -RepoRoot $(System.DefaultWorkingDirectory)/${{ repo }} -Tag ${{ parameters.Tag }} -ToolRepo ${{ parameters.ToolRepo }}
      pwsh: true
    displayName: Update Refs

  - template: /eng/common/pipelines/templates/steps/create-pull-request.yml
    parameters:
      RepoName: ${{ repo }}
      PRBranchName: UpdateRepositoryRefs
      CommitMsg: Update Repository Resource Refs in Yaml files
      PRTitle: Update Repository Resource Refs in Yaml files
      PushArgs: -f
      WorkingDirectory: $(System.DefaultWorkingDirectory)/${{ repo }}
      ScriptDirectory: $(Build.SourcesDirectory)/eng/common/scripts
      BaseBranchName: refs/heads/master